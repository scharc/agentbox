# True Docker-in-Docker Test Container for Boxctl
# Copyright (c) 2025 Marc Sch√ºtze <scharc@gmail.com>
# SPDX-License-Identifier: MIT
#
# This is a MINIMAL test controller container. It runs dockerd internally
# and executes pytest against boxctl. The actual boxctl containers
# (with node, uv, etc.) are built and run inside this container.
#
# Usage (from project root):
#   docker build -f tests/dind-tests/Dockerfile.dind -t boxctl-dind-test:latest .
#   docker run --privileged --rm boxctl-dind-test:latest

FROM ubuntu:24.04

LABEL maintainer="Marc Schuetze <marc@schuetze.io>"
LABEL description="Boxctl True DinD Test Controller"

ENV DEBIAN_FRONTEND=noninteractive

# =============================================================================
# System dependencies + Docker daemon
# =============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core utilities
    curl \
    git \
    jq \
    ca-certificates \
    gnupg \
    lsb-release \
    sudo \
    # Python (for pytest + boxctl CLI)
    python3.12 \
    python3-pip \
    python3.12-venv \
    # Docker dependencies
    iptables \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CE
RUN install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc \
    && chmod a+r /etc/apt/keyrings/docker.asc \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        docker-ce \
        docker-ce-cli \
        containerd.io \
    && rm -rf /var/lib/apt/lists/*

# Configure Docker daemon for DinD (vfs storage driver for nested Docker)
RUN mkdir -p /etc/docker
COPY tests/dind-tests/scripts/daemon.json /etc/docker/daemon.json

# =============================================================================
# Poetry + boxctl installation
# =============================================================================

# Install poetry
RUN curl -sSL https://install.python-poetry.org | python3 - \
    && ln -s /root/.local/bin/poetry /usr/local/bin/poetry

WORKDIR /build

# Copy dependency files first (layer caching)
COPY pyproject.toml poetry.lock ./

# Install ONLY runtime dependencies (no dev deps like black, mypy, ruff)
RUN poetry config virtualenvs.create false \
    && poetry install --without dev --no-root --no-interaction

# Copy source
COPY boxctl ./boxctl
COPY README.md ./

# Install boxctl package
RUN poetry install --without dev --no-interaction

# Install test dependencies (minimal - just what pytest needs)
RUN pip3 install --no-cache-dir --break-system-packages \
    pytest \
    pytest-timeout \
    pytest-html \
    pytest-json-report

# =============================================================================
# Files needed to build boxctl-base:latest inside DinD
# =============================================================================

COPY Dockerfile.base ./
COPY bin ./bin
COPY library ./library
COPY tests/dind-tests ./dind-tests

# =============================================================================
# Test user setup
# =============================================================================

RUN useradd -m -s /bin/bash -G docker testuser \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

RUN chown -R testuser:testuser /build

RUN mkdir -p \
    /home/testuser/.claude \
    /home/testuser/.codex \
    /home/testuser/.ssh \
    /home/testuser/.config/boxctl \
    && chown -R testuser:testuser /home/testuser

RUN mkdir -p /test-workspace /test-results \
    && chown testuser:testuser /test-workspace /test-results

# =============================================================================
# Entrypoint
# =============================================================================

COPY tests/dind-tests/scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
COPY tests/dind-tests/scripts/wait-for-docker.sh /usr/local/bin/wait-for-docker.sh
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/wait-for-docker.sh

ENV PYTHONPATH=/build:/build/dind-tests
ENV TEST_WORKSPACE=/test-workspace
ENV TEST_RESULTS=/test-results
ENV HOME=/home/testuser
ENV XDG_RUNTIME_DIR=/run/user/1000

RUN mkdir -p /run/user/1000 && chown testuser:testuser /run/user/1000

VOLUME /var/lib/docker

WORKDIR /build

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["pytest", "dind-tests/", "-v", "--tb=short"]
