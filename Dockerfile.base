# Copyright (c) 2025 Marc Sch√ºtze <scharc@gmail.com>
# SPDX-License-Identifier: MIT
# See LICENSE file in the project root for full license information.

# Agentbox Base Image
# Rich development environment with all common tools

FROM ubuntu:24.04

# Track the Agentbox build version in the image metadata.
ARG AGENTBOX_VERSION=dev
LABEL io.agentbox.version=$AGENTBOX_VERSION

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8

# Install system dependencies and common tools
RUN apt-get update && apt-get install -y \
    # Core utilities
    curl \
    wget \
    git \
    bash \
    bash-completion \
    sudo \
    passwd \
    ca-certificates \
    gnupg \
    lsb-release \
    locales \
    # Build essentials
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    # Python essentials
    python3.12 \
    python3-pip \
    python3-venv \
    python3-dev \
    python-is-python3 \
    # System tools
    jq \
    tree \
    htop \
    tmux \
    zsh \
    vim \
    nano \
    unzip \
    zip \
    ripgrep \
    fd-find \
    bat \
    fzf \
    httpie \
    inotify-tools \
    bc \
    # Network tools
    netcat-openbsd \
    socat \
    telnet \
    dnsutils \
    traceroute \
    net-tools \
    iputils-ping \
    openssh-client \
    # Database clients
    postgresql-client \
    mysql-client \
    redis-tools \
    # Notification support
    libnotify-bin \
    dbus-x11 \
    # Other utilities
    file \
    less \
    man-db \
    sqlite3 \
    direnv \
    entr \
    shellcheck \
    pandoc \
    gettext-base \
    && rm -rf /var/lib/apt/lists/*

# Configure locales
RUN locale-gen en_US.UTF-8

# Create abox user with UID 1000 (replacing default ubuntu user)
# container-init.sh will adjust UID/GID at runtime to match the host user
RUN userdel -r ubuntu 2>/dev/null || true \
    && groupdel ubuntu 2>/dev/null || true \
    && groupadd -g 1000 abox \
    && useradd -m -u 1000 -g 1000 -s /bin/bash abox

# Install GitHub CLI and GitLab CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh glab \
    && rm -rf /var/lib/apt/lists/*

# Install websocat (WebSocket debugging tool)
RUN ARCH=$(dpkg --print-architecture) \
    && if [ "$ARCH" = "amd64" ]; then WEBSOCAT_ARCH="x86_64"; else WEBSOCAT_ARCH="aarch64"; fi \
    && curl -fsSL "https://github.com/vi/websocat/releases/latest/download/websocat.${WEBSOCAT_ARCH}-unknown-linux-musl" -o /usr/local/bin/websocat \
    && chmod +x /usr/local/bin/websocat

# Install lazygit (TUI for git)
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | jq -r '.tag_name' | sed 's/v//') \
    && ARCH=$(dpkg --print-architecture) \
    && if [ "$ARCH" = "amd64" ]; then LAZYGIT_ARCH="x86_64"; else LAZYGIT_ARCH="arm64"; fi \
    && curl -fsSL "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_${LAZYGIT_ARCH}.tar.gz" | tar xzf - -C /usr/local/bin lazygit

# Install yq (YAML processor)
RUN ARCH=$(dpkg --print-architecture) \
    && curl -fsSL "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_${ARCH}" -o /usr/local/bin/yq \
    && chmod +x /usr/local/bin/yq

# Install Docker CLI
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
    | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js LTS
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Normalize npm globals to /usr/local for consistent CLI installs.
# /usr/etc/npmrc is the global config location for nodesource npm
RUN mkdir -p /usr/etc && printf 'prefix=/usr/local\n' >/usr/etc/npmrc
ENV PATH="/home/abox/.local/bin:/home/abox/.npm-global/bin:/usr/local/sbin:/usr/local/bin:${PATH}"
# Include user pip packages in Python path (for MCP servers installed via pip)
ENV PYTHONPATH="/home/abox/.local/lib/python3.12/site-packages"

# Install global npm packages
RUN npm install -g \
    npm@latest \
    yarn \
    pnpm

# Install Claude Code via native installer as abox user
# Installs to /home/abox/.local/bin/claude (already in PATH)
USER abox
RUN curl -fsSL https://claude.ai/install.sh | bash
USER root

# Install OpenAI Codex, Gemini, and Qwen CLIs via npm
RUN npm install -g \
    @openai/codex \
    @google/gemini-cli \
    @qwen-code/qwen-code

# Install AgentPipe (multi-agent orchestration)
RUN ARCH=$(dpkg --print-architecture) \
    && curl -fsSL "https://github.com/kevinelliott/agentpipe/releases/latest/download/agentpipe_linux_${ARCH}.tar.gz" \
    | tar xzf - -C /usr/local/bin \
    && mv /usr/local/bin/agentpipe_linux_${ARCH} /usr/local/bin/agentpipe \
    && chmod +x /usr/local/bin/agentpipe

# Install VSCode CLI for /ide integration
# This allows claude --ide to connect to host VSCode
RUN curl -Lk 'https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64' --output /tmp/vscode_cli.tar.gz \
    && tar -xzf /tmp/vscode_cli.tar.gz -C /usr/local/bin \
    && rm /tmp/vscode_cli.tar.gz \
    && chmod +x /usr/local/bin/code

# Install Poetry system-wide (accessible to all users)
ENV POETRY_HOME=/usr/local/poetry
RUN curl -sSL https://install.python-poetry.org | python3 - \
    && ln -s /usr/local/poetry/bin/poetry /usr/local/bin/poetry \
    && chmod -R a+rx /usr/local/poetry

# Install uv as abox user
# Installs to /home/abox/.local/bin/ (already in PATH)
USER abox
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
USER root

# Install common Python packages
# --ignore-installed handles conflicts with system-installed packages (e.g., rich)
RUN pip3 install --no-cache-dir --break-system-packages --ignore-installed \
    pipenv \
    virtualenv \
    black \
    pylint \
    pytest \
    requests \
    pyyaml \
    fastapi \
    "uvicorn[standard]" \
    websockets \
    starlette \
    sse-starlette \
    "litellm[proxy]" \
    httpx \
    fastmcp

# Copy and install agentbox package (needed for agentctl)
COPY agentbox /tmp/agentbox-build/agentbox
COPY pyproject.toml /tmp/agentbox-build/pyproject.toml
COPY README.md /tmp/agentbox-build/README.md
RUN pip3 install --no-cache-dir --break-system-packages poetry-core \
    && pip3 install --no-cache-dir --break-system-packages /tmp/agentbox-build \
    && rm -rf /tmp/agentbox-build \
    && rm -f /usr/local/bin/abox /usr/local/bin/agentbox  # Host-only CLIs

# Create directory structure
RUN mkdir -p /workspace \
    /agentbox/library/config \
    /agentbox/library/mcp \
    /agentbox/library/tools \
    /agentbox/library/skills \
    /context

# Copy container scripts
COPY bin/container-init.sh /usr/local/bin/container-init.sh
COPY bin/install-packages.py /usr/local/bin/install-packages.py
COPY bin/start-mcp-servers.py /usr/local/bin/start-mcp-servers.py
COPY bin/generate-mcp-config.py /usr/local/bin/generate-mcp-config.py
COPY bin/mcp-bridge.py /usr/local/bin/mcp-bridge.py
COPY bin/container-healthcheck.sh /usr/local/bin/container-healthcheck.sh
COPY bin/abox-notify /usr/local/bin/abox-notify
COPY bin/superclaude /usr/local/bin/superclaude
COPY bin/supercodex /usr/local/bin/supercodex
COPY bin/supergemini /usr/local/bin/supergemini
COPY bin/superqwen /usr/local/bin/superqwen
COPY bin/agentctl /usr/local/bin/agentctl
COPY bin/abox-clipboard /usr/local/bin/abox-clipboard
COPY bin/start-litellm.py /usr/local/bin/start-litellm.py
RUN chmod 755 /usr/local/bin/container-init.sh /usr/local/bin/install-packages.py \
    /usr/local/bin/start-mcp-servers.py /usr/local/bin/generate-mcp-config.py \
    /usr/local/bin/mcp-bridge.py /usr/local/bin/container-healthcheck.sh \
    /usr/local/bin/abox-notify /usr/local/bin/superclaude \
    /usr/local/bin/supercodex /usr/local/bin/supergemini /usr/local/bin/superqwen \
    /usr/local/bin/agentctl /usr/local/bin/abox-clipboard /usr/local/bin/start-litellm.py

# Install bash completions for agentbox and bundled CLIs
COPY bin/completions/*.bash /etc/bash_completion.d/

# Install zsh completions
RUN mkdir -p /usr/share/zsh/site-functions
COPY bin/completions/agentctl-completion.zsh /usr/share/zsh/site-functions/_agentctl

# Working directory
WORKDIR /workspace

# Entrypoint runs container initialization
ENTRYPOINT ["/usr/local/bin/container-init.sh"]

# Health check - ensures container is fully initialized before marking healthy
# start-period=180s allows for heavy MCP installs (e.g., Playwright with Chrome)
HEALTHCHECK --interval=5s --timeout=3s --start-period=180s --retries=3 \
    CMD /usr/local/bin/container-healthcheck.sh
