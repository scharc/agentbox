#!/usr/bin/env python3
# Copyright (c) 2025 Marc Sch√ºtze <scharc@gmail.com>
# SPDX-License-Identifier: MIT
# See LICENSE file in the project root for full license information.

"""Send clipboard data to host via boxctld socket.

Usage:
    echo "text" | abox-clipboard [--selection primary|clipboard]

This script reads from stdin and sends the data to the host's clipboard
via the boxctld socket. The boxctld then uses wl-copy (Wayland)
or xclip (X11) to set the actual clipboard.

Design: Never blocks tmux. Reads stdin immediately, attempts host clipboard
in background, exits quickly. Failures are silent to avoid breaking copy-pipe.
"""

import json
import socket
import sys
import os


def _get_socket_path() -> str:
    """Find the boxctld socket path."""
    uid = os.getuid()
    path = f"/run/user/{uid}/boxctld/boxctld.sock"
    if os.path.exists(path):
        return path
    # Scan for socket in other user dirs (container may run as different UID)
    run_user = "/run/user"
    if os.path.exists(run_user):
        for user_dir in os.listdir(run_user):
            sock_path = os.path.join(run_user, user_dir, "boxctld", "boxctld.sock")
            if os.path.exists(sock_path):
                return sock_path
    return path


SOCKET_PATH = _get_socket_path()


def send_to_host(data: str, selection: str) -> None:
    """Send data to host clipboard. Runs with short timeout, errors are silent."""
    if not os.path.exists(SOCKET_PATH):
        return

    try:
        sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        sock.connect(SOCKET_PATH)
        sock.settimeout(1.0)  # Short timeout - don't block

        request = json.dumps({
            "action": "clipboard",
            "data": data,
            "selection": selection
        }) + "\n"

        sock.sendall(request.encode("utf-8"))

        # Must wait for response - boxctld processes request during this time
        # Without waiting, connection closes before boxctld handles the request
        sock.settimeout(2.0)
        try:
            sock.recv(1024)  # Wait for {"ok": true} response
        except socket.timeout:
            pass

        sock.close()
    except Exception:
        # Silent failure - don't break tmux copy-pipe
        pass


def main():
    # Parse arguments
    selection = "primary"  # Default to primary (middle-click paste)

    args = sys.argv[1:]
    if "--selection" in args:
        idx = args.index("--selection")
        if idx + 1 < len(args):
            selection = args[idx + 1]
    elif "-s" in args:
        idx = args.index("-s")
        if idx + 1 < len(args):
            selection = args[idx + 1]

    # Also support --clipboard shorthand
    if "--clipboard" in args or "-c" in args:
        selection = "clipboard"

    # Read data from stdin immediately (don't block on tty check)
    try:
        data = sys.stdin.read()
    except Exception:
        sys.exit(0)

    if not data:
        sys.exit(0)

    # Send to host clipboard directly - fast enough not to block tmux
    # (socket connect + send is very quick, ~1ms typically)
    send_to_host(data, selection)
    sys.exit(0)


if __name__ == "__main__":
    main()
