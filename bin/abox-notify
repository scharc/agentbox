#!/bin/bash
# Copyright (c) 2025 Marc Sch√ºtze <scharc@gmail.com>
# SPDX-License-Identifier: MIT
# See LICENSE file in the project root for full license information.

# Send notifications to host via agentboxd socket
# Usage: abox-notify <title> <message> <urgency> [container] [session]

set -euo pipefail

TITLE="${1:-Agentbox}"
MESSAGE="${2:-Notification}"
URGENCY="${3:-normal}"
CONTAINER="${4:-${AGENTBOX_CONTAINER:-}}"
SESSION="${5:-${AGENTBOX_SESSION_NAME:-}}"

# Fallback: try to detect container/session if not provided
if [[ -z "$CONTAINER" ]]; then
    CONTAINER=$(hostname)
fi

if [[ -z "$SESSION" ]]; then
    SESSION=$(tmux display-message -p '#S' 2>/dev/null || echo "unknown")
fi

# Extract project name from container (remove 'agentbox-' prefix)
PROJECT="${CONTAINER#agentbox-}"

# Extract agent type from session name (e.g., "claude-1234567890" -> "claude")
AGENT_TYPE="${SESSION%%-*}"
# Capitalize first letter
AGENT_TYPE="$(echo "${AGENT_TYPE:0:1}" | tr '[:lower:]' '[:upper:]')${AGENT_TYPE:1}"

# Build enhanced title with project and agent info
# Format: "Project | Agent" (e.g., "myproject | Claude")
ENHANCED_TITLE="${PROJECT} | ${AGENT_TYPE}"

# Check if enhancement is enabled in config and get agent type
CONFIG=$(python3 -c "
import sys
try:
    import yaml
    with open('/workspace/.agentbox.yml', 'r') as f:
        config = yaml.safe_load(f) or {}
        task_config = config.get('task_agents', {})
        print(task_config.get('enabled', False))
        print(task_config.get('agent', 'claude'))
        print(task_config.get('model', 'haiku'))
except:
    print('False')
    print('claude')
    print('haiku')
" 2>/dev/null)

# Parse config output
IFS=$'\n' read -r ENABLED AGENT MODEL <<< "$CONFIG"

# If enhancement enabled, try AI analysis
if [[ "$ENABLED" == "True" ]] && [[ -z "${AGENTBOX_INVOCATION_DEPTH:-}" ]]; then
    # Get buffer from env var (stall detection) or capture from tmux (hook mode)
    if [[ -n "${AGENTBOX_STALL_BUFFER:-}" ]]; then
        BUFFER="$AGENTBOX_STALL_BUFFER"
    else
        # Capture last 50 lines of session buffer
        BUFFER=$(tmux capture-pane -p -t "$SESSION" -S -50 2>/dev/null || echo "")
    fi

    if [[ -n "$BUFFER" ]]; then
        # Load prompt template from config
        PROMPT=$(python3 -c "
import sys
try:
    import yaml
    with open('/workspace/.agentbox.yml', 'r') as f:
        config = yaml.safe_load(f) or {}
        template = config.get('task_agents', {}).get('prompt_template', '''You are analyzing terminal output. Respond with ONLY a short summary (max 80 chars).

Terminal output:
\`\`\`
{buffer}
\`\`\`

Summary:''')
        buffer = sys.stdin.read()
        # Sanitize buffer
        buffer = ''.join(c for c in buffer if c.isprintable() or c in '\n\t')
        print(template.format(buffer=buffer))
except Exception as e:
    sys.exit(1)
" <<< "$BUFFER" 2>/dev/null)

        if [[ -n "$PROMPT" ]]; then
            # Call appropriate CLI based on agent type
            if [[ "$AGENT" == "codex" ]]; then
                # Codex: use exec subcommand with stdin
                SUMMARY=$(echo "$PROMPT" | AGENTBOX_INVOCATION_DEPTH=1 codex exec - --model "$MODEL" 2>/dev/null | grep -v "^mcp" | grep -v "^thinking" | grep -v "^codex$" | grep -v "^tokens used" | head -c 500 || echo "")
            else
                # Claude: use -p flag with stdin
                SUMMARY=$(echo "$PROMPT" | AGENTBOX_INVOCATION_DEPTH=1 claude -p --model "$MODEL" 2>/dev/null | head -c 500 || echo "")
            fi

            if [[ -n "$SUMMARY" ]]; then
                # AI-enhanced message replaces the original message
                MESSAGE="$SUMMARY"
                echo "AI-enhanced: $MESSAGE" >&2
            fi
        fi
    fi
fi

# Send notification to host proxy
# Use enhanced title that includes project and agent info
# Try SSH mode (local IPC socket) first, fall back to legacy socket
export ENHANCED_TITLE MESSAGE URGENCY
python3 <<'PYTHON_SCRIPT'
import json
import os
import socket
import sys

title = os.environ.get('ENHANCED_TITLE', 'Agentbox')
message = os.environ.get('MESSAGE', 'Notification')
urgency = os.environ.get('URGENCY', 'normal')

# SSH mode: local IPC socket (container_client.py)
ssh_mode_socket = "/tmp/agentbox-local.sock"

# Legacy mode: direct connection to host agentboxd socket
legacy_socket = f"/run/user/{os.getuid()}/agentboxd/agentboxd.sock"

def send_via_ssh_mode(title, message, urgency):
    """Send notification via SSH mode (local IPC socket)."""
    payload = {
        'action': 'notify',
        'title': title,
        'message': message,
        'urgency': urgency
    }

    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    sock.connect(ssh_mode_socket)
    sock.settimeout(5.0)
    sock.sendall((json.dumps(payload) + '\n').encode('utf-8'))

    # Read response
    response = b""
    while b"\n" not in response:
        chunk = sock.recv(1024)
        if not chunk:
            break
        response += chunk
    sock.close()

    if response:
        result = json.loads(response.decode('utf-8'))
        return result.get('ok', False)
    return False

def send_via_legacy(title, message, urgency):
    """Send notification via legacy socket."""
    payload = {
        'action': 'notify',
        'title': title,
        'message': message,
        'urgency': urgency
    }

    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    sock.connect(legacy_socket)
    sock.settimeout(2.0)
    sock.sendall((json.dumps(payload) + '\n').encode('utf-8'))
    sock.close()
    return True

# Try SSH mode first (preferred)
if os.path.exists(ssh_mode_socket):
    try:
        if send_via_ssh_mode(title, message, urgency):
            sys.exit(0)
        else:
            print("Notification failed via SSH mode", file=sys.stderr)
            sys.exit(1)
    except Exception as e:
        print(f"SSH mode failed: {e}, trying legacy...", file=sys.stderr)

# Fall back to legacy socket
if os.path.exists(legacy_socket):
    try:
        send_via_legacy(title, message, urgency)
        sys.exit(0)
    except Exception as e:
        print(f"Failed to send notification: {e}", file=sys.stderr)
        sys.exit(1)

print("No agentbox socket available - notification skipped", file=sys.stderr)
sys.exit(0)
PYTHON_SCRIPT
